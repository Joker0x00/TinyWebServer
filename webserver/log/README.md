# 日志系统

日志系统是实现整个webserver项目的首要前提，利用日志可以方便地调试代码，记录输出。

为了使输出的日志清晰明了，日志信息被划分成了不同的等级：

- DEBUG
- INFO
- WARN
- ERROR
- FATAL

服务器初始化时提供了一个日志等级的参数，只有大于等于该等级的日志条目才会输出。

该日志系统主要使用异步方式写入日志信息，由一个队列负责维护要输出的日志信息。其他线程要打印日志时，调用函数将内容插入到队列中；日志输出线程负责从队列中取出日志信息，并将其写入日志文件中。

## 1 生产者-消费者模型

在上述工作流程中，其他线程和输出线程构成一个生产者-消费者模型。其他线程在队列不满的情况下，插入日志信息并通知日志输出线程取出日志信息，否则挂起等待；而日志输出线程在队列不空的情况，从队列中取出日志信息并通知其他线程插入日志信息，否则挂起等待。

为了同步其他线程和日志输出线程，可以使用条件变量。

## 2 数据一致

由于该日志系统会被其他不同的线程调用，需要保证同一时间只有一个线程访问日志队列。可能会出现以下竞态情况：

- 日志队列中插入日志和取出日志时，对日志队列的访问
- 其他线程要插入日志时，会在buffer内构造日志信息

![](https://secure2.wostatic.cn/static/nS1dXLj9PTFapmwvHEei1Z/image.png?auth_key=1721658093-7QpoTHsmLXETWTfoRvKHUL-0-7d101e196d4997acb87d0aed6192676d)